name: PR Preview

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions: write-all

jobs:
  Build:
    runs-on: ubuntu-latest

    steps:
      - uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## Deploying with :page_facing_up: GitHub Pages

            | **Commit:** | ${{ github.event.pull_request.head.sha }} |
            | :-- | :-- |
            | **Status:** | üî® Building |
            | **Deploy Log:** | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |

      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - uses: actions/setup-node@v3
        with:
          node-version: 18
          cache: npm

      - if: ${{ github.event.action == 'opened'}}
        run: gh repo create prview/${{ github.event.repository.name }}-${{ github.event.pull_request.number }} --public
        env:
          GITHUB_TOKEN: ${{ secrets.BOT }}

      - run: npm ci && npm run build

      - uses: peaceiris/actions-gh-pages@v3
        with:
          personal_token: ${{ secrets.BOT }}
          publish_dir: dist
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
          external_repository: prview/${{ github.event.repository.name }}-${{ github.event.pull_request.number }}

      - name: Sleep
        run: sleep 30s
        shell: bash

      - name: Comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## Deployed with :page_facing_up: GitHub Pages

            | **Commit:** | ${{ github.event.pull_request.head.sha }} |
            | :-- | :-- |
            | **Status:** | ‚úÖ Success |
            | **Preview:** | https://prview.github.io/${{ github.event.repository.name }}-${{ github.event.pull_request.number }} |
            | **Deploy Log:** | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |

      - if: ${{ failure() }}
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          message: |
            ## Deploying with :page_facing_up: GitHub Pages

            | **Commit:** | ${{ github.event.pull_request.head.sha }} |
            | :-- | :-- |
            | **Status:** | ‚ùå Failure |
            | **Deploy Log:** | ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }} |
